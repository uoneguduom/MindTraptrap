<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/style.css" />
    <title>Afficher / Cacher votre rôle</title>
  </head>
  <body>
    <h1 id="player-title">Joueur</h1>
    <button id="toggleButton">Afficher votre rôle</button>
    <div id="texte"></div>
    <style>
      #texte {
        display: none;
      }
      #video {
        width: 300px;
        height: 200px;
        border: 2px solid black;
      }
    </style>
    <script type="module">
      const res = await fetch("https://uoneguduom.github.io/MindTraptrap/html/complice.txt");
      const complice = await res.text();

      const playerNb = localStorage.getItem("playerNb");

      if (playerNb) {
        document.getElementById("player-title").textContent = `Joueur ${playerNb}`;
      }

      document.getElementById("texte").textContent = (+playerNb === +complice) ? "Complice" : "Enquêteur";

      let bouton = document.getElementById("toggleButton");
      let texte = document.getElementById("texte");

      bouton.addEventListener("click", function () {
        texte.style.display = (texte.style.display === "none" || texte.style.display === "") ? "block" : "none";
        bouton.textContent = (texte.style.display === "block") ? "Cacher votre rôle" : "Afficher votre rôle";
      });
    </script>

    <div id="button-container">
      <a href="choosePlayer.html"><button>Revenir en arrière</button></a>
      <button id="mooveRoom">Scanner un QR Code</button>
      <video id="video" autoplay></video>
      <canvas id="canvas" hidden></canvas>
      <p id="result">Scannez un QR Code...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr"></script>
    <script>
      document.querySelector("#mooveRoom").addEventListener("click", () => {
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");
        const resultText = document.getElementById("result");

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
          .then(stream => {
            video.srcObject = stream;
          })
          .catch(error => console.error("Erreur lors de l'accès à la caméra :", error));

        function scanQRCode() {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);

          if (code) {
            resultText.textContent = "QR Code détecté : " + code.data;
            window.location.href = code.data;
          }
        }

        setInterval(scanQRCode, 500);
      });
    </script>
  </body>
</html>
